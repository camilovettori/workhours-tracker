<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Bank Holidays</title>

  <link rel="icon" href="/static/logo.png" />
  <link rel="stylesheet" href="/static/app.css?v=999">


  <style>
    .wrap{ width:min(820px,100%); margin:0 auto; padding:22px 16px 120px; }

    .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ width:44px; height:44px; border-radius:12px; object-fit:cover; }
    .muted{ color: var(--muted); font-weight:900; }
    .actions{ display:flex; gap:10px; align-items:center; }

    .yearSel{
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 1000;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      outline: none;
      cursor: pointer;
    }

    .err{ color:#b91c1c; font-weight:1000; margin-top:10px; }
    .hidden{ display:none !important; }

    /* ===== NEW UX (Summary + Tabs + Single Status Button) ===== */
    .summaryPills{
      display:flex;
      gap:12px;
      padding:14px;
      margin:10px 0 12px;
      background: rgba(255,255,255,.6);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 22px;
      box-shadow: 0 10px 30px rgba(2,6,23,.08);
    }
    .pill{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.7);
      font-weight: 900;
    }
    .pill .dot{
      width:26px;
      height:26px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-weight: 1000;
    }
    .pillPaid{ background: rgba(16,185,129,.12); }
    .pillPaid .dot{ background: rgba(16,185,129,.18); }

    .pillNotPaid{ background: rgba(239,68,68,.12); }
    .pillNotPaid .dot{ background: rgba(239,68,68,.18); }

    .pillNA{ background: rgba(100,116,139,.10); }
    .pillNA .dot{ background: rgba(100,116,139,.18); }

    .segTabs{
      display:flex;
      gap:10px;
      padding:10px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(15,23,42,.08);
      margin-bottom: 14px;
    }
    .segBtn{
      flex:1;
      padding:12px 12px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.65);
      font-weight: 1000;
      cursor: pointer;
    }
    .segBtn--active{
      background: rgba(37,99,235,.14);
      border-color: rgba(37,99,235,.22);
      color: rgba(37,99,235,1);
    }

    .holidayList{ display:flex; flex-direction:column; gap:14px; }

    .holidayCard{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 16px;
      border-radius: 22px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.72);
      box-shadow: 0 10px 30px rgba(2,6,23,.08);
    }
    .holidayCard h3{ margin:0; font-size: 20px; font-weight: 1000; letter-spacing: -.02em; }
    .holidayCard .date{ margin-top:6px; color: rgba(15,23,42,.6); font-weight:900; font-size:13px; }

    .statusBtn{
      min-width: 165px;
      padding:12px 14px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.7);
      font-weight: 1000;
      letter-spacing:.02em;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      transition:.12s ease;
    }
    .statusBtn:active{ transform: translateY(1px); }
    .statusBtn::after{ content:"›"; font-size:22px; opacity:.7; }

    .status--paid{ background: rgba(16,185,129,.22); border-color: rgba(16,185,129,.26); }
    .status--notpaid{ background: rgba(239,68,68,.22); border-color: rgba(239,68,68,.26); }
    .status--na{ background: rgba(100,116,139,.14); border-color: rgba(100,116,139,.18); }

    .mini{
      font-size:12px; font-weight:900; color: var(--muted);
      margin-top:6px;
      line-height: 1.25;
    }

    /* ===== Modal (keep yours) ===== */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalCard{
      width: min(520px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 22px 80px rgba(2,6,23,.32);
      backdrop-filter: blur(10px);
      padding: 22px 18px 18px;
      max-height: calc(100vh - 36px);
      overflow: auto;
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .modalTitleBig{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: -.03em;
      line-height: 1.05;
    }
    .modalSubtitle{
      margin-top: 6px;
      font-weight: 900;
      color: var(--muted);
      font-size: 13px;
    }
    .modalCloseIcon{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      cursor: pointer;
      font-weight: 1000;
      color: var(--muted);
    }
    .modalCloseIcon:active{ transform: translateY(1px); }

    .modalFields{ display:flex; flex-direction:column; gap: 12px; margin-top: 10px; }
    .modalField .label{ font-weight: 900; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .modalField .inp{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      font-weight: 900;
      outline: none;
    }
    .modalTip{ margin-top: 12px; font-size: 12px; font-weight: 900; color: var(--muted); line-height: 1.25; }
    .modalBottom{ margin-top: 14px; display:flex; flex-direction:column; gap: 10px; }

    .modalCancelLink{
      border: 0;
      background: transparent;
      cursor: pointer;
      font-weight: 1000;
      color: var(--muted);
      padding: 8px 4px;
      text-align:center;
    }
    .modalPrimaryBtn{
      width:100%;
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 1000;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      box-shadow: 0 10px 30px rgba(37,99,235,.22);
    }
    .modalPrimaryBtn:active{ transform: translateY(1px); }
    /* Fix alignment on mobile */
.summaryPills{ flex-wrap: nowrap; }
.pill{ min-width: 0; white-space: nowrap; }
.pill b{ display:inline-block; min-width: 18px; text-align:center; }

/* Mobile tuning */
@media (max-width: 420px){
  .summaryPills{ gap:8px; padding:12px; }
  .pill{ padding:10px 8px; font-size:13px; }
  .pill .dot{ width:22px; height:22px; }
}

  </style>
</head>

<body>
  <main class="wrap">
    <div class="top">
      <div class="brand">
        <img src="/static/logo.png" alt="logo" />
        <div>
          <div style="font-size:34px; font-weight:1000; letter-spacing:-.03em; line-height:1;">Bank Holidays</div>
          <div class="muted" id="subTitle">Ireland • —</div>
        </div>
      </div>

      <div class="actions">
        <div class="navWrap">
          <button id="btnHome" class="btn btn--pill btn--soft" type="button">Home</button>
          <button id="btnBack" class="btn btn--pill btn--ghost" type="button">Back</button>
        </div>

        <div class="yearWrap">
          <select id="yearSel" class="yearSel" aria-label="Select year"></select>
        </div>
      </div>
    </div>

    <!-- Summary pills -->
    <section class="summaryPills">
      <div class="pill pillPaid"><span class="dot">✓</span> <b id="sumPaid">0</b> Paid</div>
      <div class="pill pillNotPaid"><span class="dot">✕</span> <b id="sumNotPaid">0</b> Not Paid</div>
      <div class="pill pillNA"><span class="dot">—</span> <b id="sumNA">0</b> N/A</div>
    </section>

    <!-- Tabs -->
    <section class="segTabs">
      <button id="tabUpcoming" class="segBtn segBtn--active" type="button">Upcoming</button>
      <button id="tabPast" class="segBtn" type="button">Past</button>
    </section>

    <div class="muted" id="msg">Loading...</div>
    <div id="err" class="err"></div>

    <!-- List -->
    <section id="holidayList" class="holidayList"></section>
  </main>

  <!-- Modal -->
  <div id="paidModal" class="modalBackdrop hidden" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="modalTop">
        <div>
          <div class="modalTitleBig" id="mTitle">Mark as Paid</div>
          <div class="modalSubtitle" id="mSub"></div>
        </div>
        <button class="modalCloseIcon" id="mClose" type="button">✕</button>
      </div>

      <div class="modalFields">
        <div class="modalField">
          <div class="label">Paid date (when Tesco paid)</div>
          <input id="mPaidDate" class="inp" type="date" />
        </div>

        <div class="modalField">
          <div class="label">Paid in week #</div>
          <input id="mPaidWeek" class="inp" type="number" min="1" max="53" placeholder="ex: 5" />
        </div>
      </div>

      <div class="modalTip">Tip: Tesco pays later — use the week you received it on the payslip.</div>

      <div class="modalBottom">
        <button id="mSave" class="modalPrimaryBtn" type="button">Save</button>
        <button id="mCancel" class="modalCancelLink" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        credentials: "include",
        headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
        ...opts,
      });

      const ct = res.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await res.json() : await res.text();

      if (!res.ok) {
        const msg = (data && data.detail) ? data.detail : (typeof data === "string" ? data : "Request failed");
        const e = new Error(msg);
        e.status = res.status;
        throw e;
      }
      return data;
    }

    function back(){
      if (history.length > 1) history.back();
      else location.href = "/";
    }

    function isoWeekNumber(d = new Date()) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }

    function parseYMD(s){
      const m = String(s || "").trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if(!m) return null;
      const y = +m[1], mo = +m[2], d = +m[3];
      const t = new Date(y, mo-1, d).getTime();
      return Number.isFinite(t) ? t : null;
    }

    function bhId(it){
      const v = (it && (it.id ?? it.bh_id ?? it.bhId)) ?? null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function bhUpdate(id, payload){
      return await api(`/api/bank-holidays/${id}`, {
        method: "PATCH",
        body: JSON.stringify(payload)
      });
    }

    // ===== State =====
    let ITEMS = [];
    let MODAL_ITEM = null;
    let CURRENT_YEAR = null;
    let TAB = "upcoming"; // upcoming | past

    function setSubTitle(){
      $("subTitle").textContent = `Ireland • ${CURRENT_YEAR ?? "—"}`;
    }

    function fmtDatePretty(ymd){
      // "2026-02-02" -> "02 Feb 2026"
      const t = parseYMD(ymd);
      if(!t) return ymd;
      const d = new Date(t);
      return d.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
    }

    function isPast(ymd){
      const t = parseYMD(ymd);
      if(!t) return false;
      const d = new Date(t); d.setHours(0,0,0,0);
      const today = new Date(); today.setHours(0,0,0,0);
      return d < today;
    }

    function getStatus(it){
      // backend: applicable=false => N/A
      // backend: applicable!=false && paid=true => Paid
      // else Not Paid
      if(it.applicable === false) return "na";
      if(it.paid) return "paid";
      return "not_paid";
    }

    function statusLabel(s){
      if(s === "paid") return "PAID";
      if(s === "not_paid") return "NOT PAID";
      return "N/A";
    }
    function statusClass(s){
      if(s === "paid") return "status--paid";
      if(s === "not_paid") return "status--notpaid";
      return "status--na";
    }
    function nextStatus(s){
  // cycle: not_paid -> na -> paid -> not_paid
  if (s === "not_paid") return "na";
  if (s === "na") return "paid";
  return "not_paid";
}

    

    function updateSummary(){
      let paid=0, notPaid=0, na=0;
      for(const it of ITEMS){
        const s = getStatus(it);
        if(s === "paid") paid++;
        else if(s === "not_paid") notPaid++;
        else na++;
      }
      $("sumPaid").textContent = String(paid);
      $("sumNotPaid").textContent = String(notPaid);
      $("sumNA").textContent = String(na);
    }

    function openPaidModal(item){
      MODAL_ITEM = item;
      $("mSub").textContent = `${item.name} • ${item.date}`;
      $("mPaidDate").value = item.paid_date || "";
      $("mPaidWeek").value = item.paid_week || isoWeekNumber(new Date());
      $("paidModal").classList.remove("hidden");
      $("paidModal").setAttribute("aria-hidden","false");
      setTimeout(()=> $("mPaidDate").focus(), 0);
    }

    function closePaidModal(){
      $("paidModal").classList.add("hidden");
      $("paidModal").setAttribute("aria-hidden","true");
      MODAL_ITEM = null;
    }

    async function savePaidModal(){
      if(!MODAL_ITEM) return;

      const id = bhId(MODAL_ITEM);
      if(!id) throw new Error("BH id missing (backend data issue).");

      const paid_date = ($("mPaidDate").value || "").trim();
      const paid_week_raw = ($("mPaidWeek").value || "").trim();
      const paid_week = paid_week_raw ? Number(paid_week_raw) : null;

      await bhUpdate(id, {
        applicable: true,
        paid: true,
        paid_date: paid_date || null,
        paid_week: (Number.isFinite(paid_week) ? paid_week : null)
      });

      MODAL_ITEM.applicable = true;
      MODAL_ITEM.paid = true;
      MODAL_ITEM.paid_date = paid_date || null;
      MODAL_ITEM.paid_week = (Number.isFinite(paid_week) ? paid_week : null);

      closePaidModal();
      render();
    }

    async function applyStatus(it, newStatus){
      const id = bhId(it);
      if(!id) throw new Error("BH id missing (backend data issue).");

      if(newStatus === "na"){
        await bhUpdate(id, { applicable:false, paid:false, paid_date:null, paid_week:null });
        it.applicable = false;
        it.paid = false;
        it.paid_date = null;
        it.paid_week = null;
        return;
      }

      if(newStatus === "not_paid"){
        await bhUpdate(id, { applicable:true, paid:false, paid_date:null, paid_week:null });
        it.applicable = true;
        it.paid = false;
        it.paid_date = null;
        it.paid_week = null;
        return;
      }

      // paid -> open modal to capture date/week
      it.applicable = true;
      openPaidModal(it);
    }

    function render(){
      setSubTitle();
      updateSummary();

      const list = $("holidayList");
      list.innerHTML = "";

      const filtered = ITEMS.filter(it => TAB === "past" ? isPast(it.date) : !isPast(it.date));

      for(const it of filtered){
        const s = getStatus(it);

        const card = document.createElement("article");
        card.className = "holidayCard";
        card.innerHTML = `
          <div style="flex:1; padding-right:10px;">
            <h3>${it.name}</h3>
            <div class="date">${fmtDatePretty(it.date)}</div>
            <div class="mini">${
              (it.applicable === false)
                ? "Not applicable"
                : (it.paid
                    ? `Paid: ${it.paid_date ? it.paid_date : "—"} • Week: ${it.paid_week ? it.paid_week : "—"}`
                    : "Not paid yet")
            }</div>
          </div>
          <button class="statusBtn ${statusClass(s)}" type="button">${statusLabel(s)}</button>
        `;

        const btn = card.querySelector("button.statusBtn");
        btn.addEventListener("click", async ()=>{
          try{
            const cur = getStatus(it);
            const nxt = nextStatus(cur);
            await applyStatus(it, nxt);
            // se abriu modal (paid), a render fica depois do save; se não, atualiza agora
            render();
          }catch(e){
            alert(e.message || "Failed");
          }
        });

        list.appendChild(card);
      }
    }

    function bindTabs(){
      const up = $("tabUpcoming");
      const past = $("tabPast");

      const setTab = (t)=>{
        TAB = t;
        up.classList.toggle("segBtn--active", t === "upcoming");
        past.classList.toggle("segBtn--active", t === "past");
        render();
      };

      up.addEventListener("click", ()=> setTab("upcoming"));
      past.addEventListener("click", ()=> setTab("past"));
    }

    async function loadYear(year){
      $("err").textContent = "";
      $("msg").textContent = "Loading...";
      $("holidayList").innerHTML = "";

      try{
        const items = await api(`/api/bank-holidays/year/${year}`, { method:"GET" });

        if(!items || !items.length){
          $("msg").textContent = "No bank holidays found.";
          ITEMS = [];
          render();
          return;
        }

        $("msg").textContent = "";

        ITEMS = [...items].sort((a, b) => {
          const ta = parseYMD(a.date) ?? Number.POSITIVE_INFINITY;
          const tb = parseYMD(b.date) ?? Number.POSITIVE_INFINITY;
          return ta - tb;
        });

        render();
      }catch(e){
        $("msg").textContent = "";
        $("err").textContent = e.message || "Failed";
        if(e.status === 401) location.href = "/";
      }
    }

    async function loadYearsAndInit(){
      const sel = $("yearSel");
      sel.innerHTML = "";

      const data = await api("/api/bank-holidays/years", { method:"GET" });
      const years = (data && Array.isArray(data.years) && data.years.length) ? data.years : [2026];

      for(const y of years){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      }

      CURRENT_YEAR = Number(years[years.length - 1] || 2026);
      sel.value = String(CURRENT_YEAR);
      setSubTitle();

      sel.addEventListener("change", async ()=>{
        CURRENT_YEAR = Number(sel.value);
        setSubTitle();
        await loadYear(CURRENT_YEAR);
      });

      bindTabs();
      await loadYear(CURRENT_YEAR);
    }

    // Nav
    $("btnHome").addEventListener("click", ()=> location.href="/");
    $("btnBack").addEventListener("click", back);

    // Modal
    $("mClose").addEventListener("click", closePaidModal);
    $("mCancel").addEventListener("click", closePaidModal);
    $("mSave").addEventListener("click", async ()=>{
      try{ await savePaidModal(); }
      catch(e){ alert(e.message || "Failed to save"); }
    });
    $("paidModal").addEventListener("click", (ev)=>{
      if(ev.target === $("paidModal")) closePaidModal();
    });

    loadYearsAndInit();
  </script>
</body>
</html>
