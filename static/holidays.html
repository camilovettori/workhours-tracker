<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Bank Holidays</title>

  <link rel="icon" href="/static/logo.png" />
  <link rel="stylesheet" href="/static/app.css?v=12" />

  <style>
    .wrap{ width:min(820px,100%); margin:0 auto; padding:22px 16px 120px; }
    .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ width:44px; height:44px; border-radius:12px; object-fit:cover; }
    .muted{ color: var(--muted); font-weight:900; }
    .cardPad{ padding:16px; }
    .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:12px 12px; border-radius:14px; border:1px solid rgba(15,23,42,.08); background: rgba(255,255,255,.60); }
    .row + .row{ margin-top:10px; }
    .t1{ font-weight:1000; }
    .t2{ color: var(--muted); font-weight:900; font-size:13px; margin-top:2px; }
    .err{ color:#b91c1c; font-weight:1000; margin-top:10px; }

    .actions{ display:flex; gap:10px; align-items:center; }

    .yearSel{
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 1000;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      outline: none;
      cursor: pointer;
    }

    .pillGrp{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pillBtn{
      padding:8px 12px; border-radius:999px; font-weight:1000;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      transition: .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:hover{ transform: translateY(-1px); }
    .pillBtn--on{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.10);
      color: rgba(37,99,235,1);
    }
    .mini{
      font-size:12px; font-weight:900; color: var(--muted);
      margin-top:6px;
      line-height: 1.25;
    }

    .hidden{ display:none !important; }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }

    .modalCard{
      width: min(520px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 22px 80px rgba(2,6,23,.32);
      backdrop-filter: blur(10px);
      padding: 22px 18px 18px;
      max-height: calc(100vh - 36px);
      overflow: auto;
    }

    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .modalTitleBig{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: -.03em;
      line-height: 1.05;
    }

    .modalSubtitle{
      margin-top: 6px;
      font-weight: 900;
      color: var(--muted);
      font-size: 13px;
    }

    .modalCloseIcon{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      cursor: pointer;
      font-weight: 1000;
      color: var(--muted);
    }
    .modalCloseIcon:active{ transform: translateY(1px); }

    .modalFields{
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 10px;
    }

    .modalField .label{
      font-weight: 900;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .modalField .inp{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      font-weight: 900;
      outline: none;
    }

    .modalTip{
      margin-top: 12px;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      line-height: 1.25;
    }

    .modalBottom{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .modalCancelLink{
      border: 0;
      background: transparent;
      cursor: pointer;
      font-weight: 1000;
      color: var(--muted);
      padding: 8px 4px;
      text-align:center;
    }

    .modalPrimaryBtn{
      width:100%;
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 1000;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      box-shadow: 0 10px 30px rgba(37,99,235,.22);
    }
    .modalPrimaryBtn:active{ transform: translateY(1px); }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="top">
      <div class="brand">
        <img src="/static/logo.png" alt="logo" />
        <div>
          <div style="font-size:34px; font-weight:1000; letter-spacing:-.03em; line-height:1;">Bank Holidays</div>
          <div class="muted" id="subTitle">Ireland • —</div>
        </div>
      </div>

      <div class="actions">
        <select id="yearSel" class="yearSel" aria-label="Select year"></select>
        <button id="btnHome" class="btn btn--pill btn--soft" type="button">Home</button>
        <button id="btnBack" class="btn btn--pill btn--ghost" type="button">Back</button>
      </div>
    </div>

    <section class="card cardPad">
      <div class="muted" id="msg">Loading...</div>
      <div id="err" class="err"></div>
      <div id="list" style="margin-top:12px;"></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="paidModal" class="modalBackdrop hidden" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="modalTop">
        <div>
          <div class="modalTitleBig" id="mTitle">Mark as Paid</div>
          <div class="modalSubtitle" id="mSub"></div>
        </div>
        <button class="modalCloseIcon" id="mClose" type="button">✕</button>
      </div>

      <div class="modalFields">
        <div class="modalField">
          <div class="label">Paid date (when Tesco paid)</div>
          <input id="mPaidDate" class="inp" type="date" />
        </div>

        <div class="modalField">
          <div class="label">Paid in week #</div>
          <input id="mPaidWeek" class="inp" type="number" min="1" max="53" placeholder="ex: 5" />
        </div>
      </div>

      <div class="modalTip">Tip: Tesco pays later — use the week you received it on the payslip.</div>

      <div class="modalBottom">
        <button id="mSave" class="modalPrimaryBtn" type="button">Save</button>
        <button id="mCancel" class="modalCancelLink" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        credentials: "include",
        headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
        ...opts,
      });

      const ct = res.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await res.json() : await res.text();

      if (!res.ok) {
        const msg = (data && data.detail) ? data.detail : (typeof data === "string" ? data : "Request failed");
        const e = new Error(msg);
        e.status = res.status;
        throw e;
      }
      return data;
    }

    function back(){
      if (history.length > 1) history.back();
      else location.href = "/";
    }

    function isoWeekNumber(d = new Date()) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }

    function parseYMD(s){
      const m = String(s || "").trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if(!m) return null;
      const y = +m[1], mo = +m[2], d = +m[3];
      const t = new Date(y, mo-1, d).getTime();
      return Number.isFinite(t) ? t : null;
    }

    function bhId(it){
      const v = (it && (it.id ?? it.bh_id ?? it.bhId)) ?? null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function bhUpdate(id, payload){
      // backend tem PATCH e PUT, mas PATCH é o padrão
      return await api(`/api/bank-holidays/${id}`, {
        method: "PATCH",
        body: JSON.stringify(payload)
      });
    }

    let ITEMS = [];
    let MODAL_ITEM = null;
    let CURRENT_YEAR = null;

    function setSubTitle(){
      $("subTitle").textContent = `Ireland • ${CURRENT_YEAR ?? "—"}`;
    }

    function openPaidModal(item){
      MODAL_ITEM = item;
      $("mSub").textContent = `${item.name} • ${item.date}`;
      $("mPaidDate").value = item.paid_date || "";
      $("mPaidWeek").value = item.paid_week || isoWeekNumber(new Date());
      $("paidModal").classList.remove("hidden");
      $("paidModal").setAttribute("aria-hidden","false");
      setTimeout(()=> $("mPaidDate").focus(), 0);
    }

    function closePaidModal(){
      $("paidModal").classList.add("hidden");
      $("paidModal").setAttribute("aria-hidden","true");
      MODAL_ITEM = null;
    }

    async function setPaid(item, paid){
      if(item.applicable === false){
  // re-enable automatically if user tries to mark paid/not paid
  await bhUpdate(bhId(item), { applicable: true });
  item.applicable = true;
}

      if(!item) return;

      if(paid){
        openPaidModal(item);
        return;
      }

      const id = bhId(item);
      if(!id) throw new Error("BH id missing (backend data issue).");

      await bhUpdate(id, { paid:false });

      item.paid = false;
      item.paid_date = null;
      item.paid_week = null;
      render();
    }

    async function savePaidModal(){
      if(!MODAL_ITEM) return;

      const id = bhId(MODAL_ITEM);
      if(!id) throw new Error("BH id missing (backend data issue).");

      const paid_date = ($("mPaidDate").value || "").trim();
      const paid_week_raw = ($("mPaidWeek").value || "").trim();
      const paid_week = paid_week_raw ? Number(paid_week_raw) : null;

      await bhUpdate(id, {
        paid: true,
        paid_date: paid_date || null,
        paid_week: (Number.isFinite(paid_week) ? paid_week : null)
      });

      MODAL_ITEM.paid = true;
      MODAL_ITEM.paid_date = paid_date || null;
      MODAL_ITEM.paid_week = (Number.isFinite(paid_week) ? paid_week : null);

      closePaidModal();
      render();
    }

    function render(){
      const list = $("list");
      list.innerHTML = "";

      for(const it of ITEMS){
        const div = document.createElement("div");
        div.className = "row";

        let paidMeta = "";
if(it.applicable === false){
  paidMeta = `<div class="mini">Not applicable</div>`;
}else{
  paidMeta = it.paid
    ? `<div class="mini">Paid: ${it.paid_date ? it.paid_date : "—"} • Week: ${it.paid_week ? it.paid_week : "—"}</div>`
    : `<div class="mini">Not paid yet</div>`;
}


        div.innerHTML = `
          <div style="flex:1;">
            <div class="t1">${it.name}</div>
            <div class="t2">${it.date}</div>
            ${paidMeta}
          </div>

          <div class="pillGrp">
  <div class="pillBtn ${it.applicable === false ? "pillBtn--on":""}" data-act="na">N/A</div>
  <div class="pillBtn ${it.applicable !== false && !it.paid ? "pillBtn--on":""}" data-act="notpaid">Not paid</div>
  <div class="pillBtn ${it.applicable !== false && it.paid ? "pillBtn--on":""}" data-act="paid">Paid</div>
</div>

        `;

        div.querySelector('[data-act="paid"]').addEventListener("click", ()=> {
          try{ setPaid(it, true); }catch(e){ alert(e.message || "Failed"); }
        });

        div.querySelector('[data-act="notpaid"]').addEventListener("click", async ()=> {
          try{ await setPaid(it, false); }catch(e){ alert(e.message || "Failed"); }
        });

        div.querySelector('[data-act="na"]').addEventListener("click", async ()=> {
  try{
    const id = bhId(it);
    await bhUpdate(id, { applicable: false });
    it.applicable = false;
    it.paid = false;
    it.paid_date = null;
    it.paid_week = null;
    render();
  }catch(e){
    alert(e.message || "Failed");
  }
});


        list.appendChild(div);
      }

      setSubTitle();
    }

    async function loadYear(year){
      $("err").textContent = "";
      $("list").innerHTML = "";
      $("msg").textContent = "Loading...";

      try{
        const items = await api(`/api/bank-holidays/year/${year}`, { method:"GET" });

        if(!items || !items.length){
          $("msg").textContent = "No bank holidays found.";
          ITEMS = [];
          render();
          return;
        }

        $("msg").textContent = "";

        ITEMS = [...items].sort((a, b) => {
          const ta = parseYMD(a.date) ?? Number.POSITIVE_INFINITY;
          const tb = parseYMD(b.date) ?? Number.POSITIVE_INFINITY;
          return ta - tb;
        });

        render();
      }catch(e){
        $("msg").textContent = "";
        $("err").textContent = e.message || "Failed";
        if(e.status === 401) location.href = "/";
      }
    }

    async function loadYearsAndInit(){
      const sel = $("yearSel");
      sel.innerHTML = "";

      const data = await api("/api/bank-holidays/years", { method:"GET" });
      const years = (data && Array.isArray(data.years) && data.years.length) ? data.years : [2026];

      for(const y of years){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      }

      // default: maior ano disponível (mais recente)
      CURRENT_YEAR = Number(years[years.length - 1] || 2026);
      sel.value = String(CURRENT_YEAR);
      setSubTitle();

      sel.addEventListener("change", async ()=>{
        CURRENT_YEAR = Number(sel.value);
        setSubTitle();
        await loadYear(CURRENT_YEAR);
      });

      await loadYear(CURRENT_YEAR);
    }

    $("btnHome").addEventListener("click", ()=> location.href="/");
    $("btnBack").addEventListener("click", back);

    $("mClose").addEventListener("click", closePaidModal);
    $("mCancel").addEventListener("click", closePaidModal);
    $("mSave").addEventListener("click", async ()=>{
      try{
        await savePaidModal();
      }catch(e){
        alert(e.message || "Failed to save");
      }
    });

    $("paidModal").addEventListener("click", (ev)=>{
      if(ev.target === $("paidModal")) closePaidModal();
    });

    loadYearsAndInit();
  </script>
</body>
</html>
