<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Bank Holidays</title>

  <link rel="icon" href="/static/logo.png" />
  <link rel="stylesheet" href="/static/app.css?v=12" />

  <style>
    .wrap{ width:min(820px,100%); margin:0 auto; padding:22px 16px 120px; }
    .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ width:44px; height:44px; border-radius:12px; object-fit:cover; }
    .muted{ color: var(--muted); font-weight:900; }
    .cardPad{ padding:16px; }
    .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:12px 12px; border-radius:14px; border:1px solid rgba(15,23,42,.08); background: rgba(255,255,255,.60); }
    .row + .row{ margin-top:10px; }
    .t1{ font-weight:1000; }
    .t2{ color: var(--muted); font-weight:900; font-size:13px; margin-top:2px; }
    .err{ color:#b91c1c; font-weight:1000; margin-top:10px; }
    .actions{ display:flex; gap:10px; }

    .pillGrp{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pillBtn{
      padding:8px 12px; border-radius:999px; font-weight:1000;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      transition: .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:hover{ transform: translateY(-1px); }
    .pillBtn--on{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.10);
      color: rgba(37,99,235,1);
    }
    .mini{
      font-size:12px; font-weight:900; color: var(--muted);
      margin-top:6px;
      line-height: 1.25;
    }

    /* ===== Modal (IDÊNTICO ao card do Add week) ===== */
    .hidden{ display:none !important; }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }

    /* card igual Add week */
    .modalCard{
      width: min(520px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 22px 80px rgba(2,6,23,.32);
      backdrop-filter: blur(10px);
      padding: 22px 18px 18px;
      max-height: calc(100vh - 36px);
      overflow: auto;
    }

    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .modalTitleBig{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: -.03em;
      line-height: 1.05;
    }

    .modalSubtitle{
      margin-top: 6px;
      font-weight: 900;
      color: var(--muted);
      font-size: 13px;
    }

    .modalCloseIcon{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      cursor: pointer;
      font-weight: 1000;
      color: var(--muted);
    }
    .modalCloseIcon:active{ transform: translateY(1px); }

    .modalFields{
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 10px;
    }

    .modalField .label{
      font-weight: 900;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .modalField .inp{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      font-weight: 900;
      outline: none;
    }

    .modalTip{
      margin-top: 12px;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      line-height: 1.25;
    }

    .modalBottom{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .modalCancelLink{
      border: 0;
      background: transparent;
      cursor: pointer;
      font-weight: 1000;
      color: var(--muted);
      padding: 8px 4px;
      text-align:center;
    }

    .modalPrimaryBtn{
      width:100%;
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 1000;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      box-shadow: 0 10px 30px rgba(37,99,235,.22);
    }
    .modalPrimaryBtn:active{ transform: translateY(1px); }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="top">
      <div class="brand">
        <img src="/static/logo.png" alt="logo" />
        <div>
          <div style="font-size:34px; font-weight:1000; letter-spacing:-.03em; line-height:1;">Bank Holidays</div>
          <div class="muted">Ireland • 2026</div>
        </div>
      </div>

      <div class="actions">
        <button id="btnHome" class="btn btn--pill btn--soft" type="button">Home</button>
        <button id="btnBack" class="btn btn--pill btn--ghost" type="button">Back</button>
      </div>
    </div>

    <section class="card cardPad">
      <div class="muted" id="msg">Loading...</div>
      <div id="err" class="err"></div>
      <div id="list" style="margin-top:12px;"></div>
    </section>
  </main>

  <!-- Modal (Add-week style) -->
  <div id="paidModal" class="modalBackdrop hidden" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="modalTop">
        <div>
          <div class="modalTitleBig" id="mTitle">Mark as Paid</div>
          <div class="modalSubtitle" id="mSub"></div>
        </div>
        <button class="modalCloseIcon" id="mClose" type="button">✕</button>
      </div>

      <div class="modalFields">
        <div class="modalField">
          <div class="label">Paid date (when Tesco paid)</div>
          <input id="mPaidDate" class="inp" type="date" />
        </div>

        <div class="modalField">
          <div class="label">Paid in week #</div>
          <input id="mPaidWeek" class="inp" type="number" min="1" max="53" placeholder="ex: 5" />
        </div>
      </div>

      <div class="modalTip">Tip: Tesco pays later — use the week you received it on the payslip.</div>

      <div class="modalBottom">
        <button id="mSave" class="modalPrimaryBtn" type="button">Save</button>
        <button id="mCancel" class="modalCancelLink" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        credentials: "include",
        headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
        ...opts,
      });
      const ct = res.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await res.json() : await res.text();
      if (!res.ok) {
        const msg = (data && data.detail) ? data.detail : (typeof data === "string" ? data : "Request failed");
        const e = new Error(msg);
        e.status = res.status;
        throw e;
      }
      return data;
    }

    function back(){
      if (history.length > 1) history.back();
      else location.href = "/";
    }

    function isoWeekNumber(d = new Date()) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }

    let ITEMS = [];
    let MODAL_ITEM = null;

    function openPaidModal(item){
      MODAL_ITEM = item;

      $("mSub").textContent = `${item.name} • ${item.date}`;
      $("mPaidDate").value = item.paid_date || "";
      $("mPaidWeek").value = item.paid_week || isoWeekNumber(new Date());

      $("paidModal").classList.remove("hidden");
      $("paidModal").setAttribute("aria-hidden","false");
      setTimeout(()=> $("mPaidDate").focus(), 0);
    }

    function closePaidModal(){
      $("paidModal").classList.add("hidden");
      $("paidModal").setAttribute("aria-hidden","true");
      MODAL_ITEM = null;
    }

    async function setPaid(item, paid){
      if(!item) return;

      if(paid){
        openPaidModal(item);
        return;
      }

      await api(`/api/bank-holidays/${item.id}`, {
        method:"PATCH",
        body: JSON.stringify({ paid:false })
      });

      item.paid = false;
      item.paid_date = null;
      item.paid_week = null;
      render();
    }

    async function savePaidModal(){
      if(!MODAL_ITEM) return;

      const paid_date = ($("mPaidDate").value || "").trim();
      const paid_week = Number(($("mPaidWeek").value || "").trim() || 0) || null;

      await api(`/api/bank-holidays/${MODAL_ITEM.id}`, {
        method:"PATCH",
        body: JSON.stringify({
          paid: true,
          paid_date: paid_date || null,
          paid_week: paid_week
        })
      });

      MODAL_ITEM.paid = true;
      MODAL_ITEM.paid_date = paid_date || null;
      MODAL_ITEM.paid_week = paid_week;

      closePaidModal();
      render();
    }

    function render(){
      const list = $("list");
      list.innerHTML = "";

      for(const it of ITEMS){
        const div = document.createElement("div");
        div.className = "row";

        const paidMeta = it.paid
          ? `<div class="mini">Paid: ${it.paid_date ? it.paid_date : "—"} • Week: ${it.paid_week ? it.paid_week : "—"}</div>`
          : `<div class="mini">Not paid yet</div>`;

        div.innerHTML = `
          <div style="flex:1;">
            <div class="t1">${it.name}</div>
            <div class="t2">${it.date}</div>
            ${paidMeta}
          </div>

          <div class="pillGrp">
            <div class="pillBtn ${!it.paid ? "pillBtn--on":""}" data-act="notpaid">Not paid</div>
            <div class="pillBtn ${it.paid ? "pillBtn--on":""}" data-act="paid">Paid</div>
          </div>
        `;

        div.querySelector('[data-act="paid"]').addEventListener("click", ()=> setPaid(it, true));
        div.querySelector('[data-act="notpaid"]').addEventListener("click", ()=> setPaid(it, false));

        list.appendChild(div);
      }
    }

    // ===== CHANGE ONLY WHAT'S NEEDED: ORDER ASC BY DATE =====
   function dateKey(it){
  const s = String(it.date || it.date_ymd || it.work_date || it.ymd || "").trim();
  if(!s) return Number.POSITIVE_INFINITY;

  // YYYY-M-D or YYYY-MM-DD
  let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (m){
    const y = +m[1], mo = +m[2], d = +m[3];
    const t = new Date(y, mo-1, d).getTime();
    return Number.isFinite(t) ? t : Number.POSITIVE_INFINITY;
  }

  // DD/M/YYYY or DD/MM/YYYY
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m){
    const d = +m[1], mo = +m[2], y = +m[3];
    const t = new Date(y, mo-1, d).getTime();
    return Number.isFinite(t) ? t : Number.POSITIVE_INFINITY;
  }

  // last fallback: try Date.parse
  const t = Date.parse(s);
  return Number.isFinite(t) ? t : Number.POSITIVE_INFINITY;
}
async function load(){
  $("err").textContent = "";
  $("list").innerHTML = "";
  $("msg").textContent = "Loading...";

  try{
    const items = await api("/api/bank-holidays/2026", { method:"GET", headers:{} });

    if(!items || !items.length){
      $("msg").textContent = "No bank holidays found.";
      return;
    }

    $("msg").textContent = "";

  



   ITEMS = [...items].sort((a, b) => {
  return new Date(a.date) - new Date(b.date);
});

render();


  }catch(e){
    $("msg").textContent = "";
    $("err").textContent = e.message || "Failed";
    if(e.status === 401) location.href = "/";
  }
}

    
    $("btnHome").addEventListener("click", ()=> location.href="/");
    $("btnBack").addEventListener("click", back);

    $("mClose").addEventListener("click", closePaidModal);
    $("mCancel").addEventListener("click", closePaidModal);
    $("mSave").addEventListener("click", async ()=>{
      try{
        await savePaidModal();
      }catch(e){
        alert(e.message || "Failed to save");
      }
    });

    // click outside closes
    $("paidModal").addEventListener("click", (ev)=>{
      if(ev.target === $("paidModal")) closePaidModal();
    });

    load();
  </script>
</body>
</html>
