<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Week summary</title>

  <link rel="icon" href="/static/logo.png" />
  <link rel="stylesheet" href="/static/app.css?v=12" />

  <style>
    /* FIX: Save button appearing washed/white in the modal */
    #editModal .modalActions button[type="submit"]{
      background: rgba(37,99,235,1) !important;
      color: #fff !important;
      border: 1px solid rgba(37,99,235,.35) !important;
      opacity: 1 !important;
      filter: none !important;
      width: 100%;
    }
    #editModal .modalActions button[type="submit"]:hover{
      background: rgba(37,99,235,.92) !important;
    }

    .reportWrap{ width:min(820px,100%); margin:0 auto; padding:22px 16px 120px; }
    .brandRow{ display:flex; align-items:center; gap:12px; }
    .brandRow img{ width:44px; height:44px; border-radius:12px; object-fit:cover; }
    .topbarRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .cardPad{ padding:16px; }
    .muted{ color: var(--muted); font-weight:800; }

    .weekItem{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px; border-radius:18px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.60);
      cursor:pointer;
      transition: transform .06s ease;
    }
    .weekItem:hover{ transform: translateY(-1px); }
    .weekItem + .weekItem{ margin-top:10px; }
    .weekLeft .t1{ font-weight:1000; font-size:16px; }
    .weekLeft .t2{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:900; }
    .weekRight{ text-align:right; }
    .weekRight .hhmm{ font-weight:1000; font-size:18px; }
    .weekRight .eur{ margin-top:2px; font-weight:1000; color:var(--muted); }

    table{ width:100%; border-collapse:collapse; font-weight:900; }
    th,td{ padding:10px 8px; border-bottom:1px solid rgba(15,23,42,.08); text-align:left; }
    th{ font-size:12px; color:var(--muted); letter-spacing:.04em; text-transform:uppercase; }
    td{ font-size:14px; }

    .rowClick{ cursor:pointer; }
    .rowClick:hover{ background: rgba(15,23,42,.03); }

    .totalsBox{
      margin-top:14px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.18);
      border-radius:18px;
      padding:16px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px;
    }
    .totalsBox .big{ font-size:44px; font-weight:1000; letter-spacing:-.04em; line-height:1; }
    .totalsBox .label{ color:var(--muted); font-weight:1000; }
    .totalsBox .pay{ font-size:36px; font-weight:1000; line-height:1; text-align:right; }
    .err{ color:#b91c1c; font-weight:1000; margin-top:8px; }

    .actionsRow{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }
    .btnSmall{ padding:10px 14px; border-radius:14px; font-weight:1000; }
    .btnDanger{ border:1px solid rgba(185,28,28,.22); background: rgba(185,28,28,.08); }
    .btnDanger:hover{ background: rgba(185,28,28,.12); }

    /* modal */
    .modal{ position:fixed; inset:0; background: rgba(2,6,23,.45); display:flex; align-items:center; justify-content:center; padding:16px; z-index:9999; }
    .modal.hidden{ display:none; }
    .modalCard{ width:min(520px,100%); background: rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.10); border-radius:22px; box-shadow: 0 30px 80px rgba(2,6,23,.30); padding:16px; }
    .modalTop{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .modalTitle{ font-size:18px; font-weight:1000; }
    .modalClose{ border:none; background:transparent; font-size:18px; font-weight:1000; cursor:pointer; padding:6px 10px; border-radius:12px; }
    .modalClose:hover{ background: rgba(15,23,42,.06); }

    .form{ display:flex; flex-direction:column; gap:10px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field span{ font-weight:900; color: var(--muted); font-size:13px; }
    .field input{ padding:12px 12px; border-radius:14px; border:1px solid rgba(15,23,42,.12); background: rgba(255,255,255,.75); font-weight:900; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .modalActions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }

    @media print{
      #btnBack, #btnHome, .actionsRow, #editModal, #addWeekModal2, #dayModal { display:none !important; }
      body{ background:#fff !important; }
      .reportWrap{ padding:0 !important; width:100% !important; }
      .card{ box-shadow:none !important; }
    }
  </style>
</head>

<!-- DAY DETAILS MODAL -->
<div id="dayModal" class="modal hidden">
  <div class="modalCard">
    <div class="modalHeader" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <h2 id="ddTitle" style="margin:0;">Day details</h2>
      <button class="modalClose" type="button" onclick="closeDayModal()">‚úï</button>
    </div>

    <div class="modalSection" style="margin-top:10px;">
      <h4 style="margin:0 0 6px;">üïí Clocked</h4>
      <div id="ddClocked"></div>
    </div>

    <div class="modalSection" style="margin-top:10px;">
      <h4 style="margin:0 0 6px;">üè¢ Tesco rules</h4>
      <div id="ddTesco"></div>
    </div>

    <div class="modalSection highlight" style="margin-top:10px;">
      <h4 style="margin:0 0 6px;">üìä Result</h4>
      <div id="ddResult"></div>
    </div>
  </div>
</div>

<body>
  <main class="reportWrap">
    <div class="topbarRow">
      <div class="brandRow">
        <img src="/static/logo.png" alt="logo" />
        <div>
          <div style="font-size:34px; font-weight:1000; letter-spacing:-.03em; line-height:1;">Week summary</div>
          <div id="subTitle" class="muted">Select a week</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button id="btnHome" class="btn btn--pill btn--soft" type="button">Home</button>
        <button id="btnBack" class="btn btn--pill btn--ghost" type="button">Back</button>
      </div>
    </div>

    <!-- LIST VIEW -->
    <section id="viewList" class="card cardPad">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
        <div style="font-size:18px; font-weight:1000;">Weeks</div>
        <button id="btnAddWeekHere" class="btn btn--soft btnSmall" type="button">+ Add week</button>
      </div>

      <div id="weeksList"></div>

      <div id="listMsg" class="muted" style="margin-top:10px;"></div>
      <div id="listErr" class="err"></div>
    </section>

    <!-- DETAIL VIEW -->
    <section id="viewDetail" class="card cardPad hidden">
      <div class="muted" style="display:flex; justify-content:space-between; gap:12px;">
        <div>
          <div>Hourly rate</div>
          <div id="rateText" style="font-size:18px; font-weight:1000; color:var(--text); margin-top:4px;">‚Äî</div>
        </div>
        <div style="text-align:right;">
          <div>Start date</div>
          <div id="startDateText" style="font-size:18px; font-weight:1000; color:var(--text); margin-top:4px;">‚Äî</div>
        </div>
      </div>

      <div class="actionsRow">
        <button id="btnAddDay" class="btn btn--soft btnSmall" type="button">+ Add day</button>
        <button id="btnPrint" class="btn btn--soft btnSmall" type="button">Print</button>
        <button id="btnDeleteWeek" class="btn btn--soft btnSmall btnDanger" type="button">Delete week</button>
      </div>

      <div id="detailErr" class="err"></div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Day</th>
              <th>Date</th>
              <th>In</th>
              <th>Out</th>
              <th>Break</th>
              <th>Worked</th>
              <th>Pay</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <div class="muted" style="margin-top:10px;">Tip: click any day to edit or delete.</div>
      </div>

      <div class="totalsBox">
        <div>
          <div class="label">Total hours</div>
          <div id="totalHHMM" class="big">00:00</div>
          
          
        </div>
        <div style="text-align:right;">
          <div class="label">Gross pay</div>
          <div id="totalPay" class="pay">‚Ç¨0.00</div>
        </div>
      </div>
    </section>
  </main>

  <!-- EDIT / ADD DAY MODAL -->
  <div id="editModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">Edit day</div>
        <button id="btnCloseModal" class="modalClose" type="button">‚úï</button>
      </div>

      <form id="editForm" class="form">
        <label class="field">
          <span>Date</span>
          <input id="mDate" type="date" required />
        </label>

        <div class="row2">
          <label class="field">
            <span>IN (HH:MM)</span>
            <input id="mIn" type="time" />
          </label>
          <label class="field">
            <span>OUT (HH:MM)</span>
            <input id="mOut" type="time" />
          </label>
        </div>

        <div class="row2">
          <label class="field">
            <span>Break (minutes)</span>
            <input id="mBreak" type="number" min="0" step="1" value="0" />
          </label>
          <label class="field">
            <span>Note (optional)</span>
            <input id="mNote" type="text" placeholder="optional" />
          </label>
        </div>

        <div id="modalErr" class="err"></div>

        <div class="modalActions">
          <button id="btnDeleteDay" class="btn btn--soft btnSmall btnDanger" type="button">Delete day</button>
          <button class="btn btn--primary btnSmall" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ADD WEEK MODAL (report page) -->
  <div id="addWeekModal2" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalTop">
        <div class="modalTitle">Add week</div>
        <button id="btnCloseAddWeek2" class="modalClose" type="button">‚úï</button>
      </div>

      <form id="addWeekForm2" class="form">
        <label class="field">
          <span>Week number</span>
          <input id="aw2WeekNumber" type="number" min="1" max="53" required />
        </label>

        <label class="field">
          <span>Start date</span>
          <input id="aw2StartDate" type="date" required />
        </label>

        <label class="field">
          <span>Hourly rate (‚Ç¨)</span>
          <input id="aw2HourlyRate" type="number" step="0.01" min="0" required />
        </label>

        <div id="addWeekErr2" class="err"></div>

        <div class="modalActions">
          <button class="btn btn--primary btnSmall" type="submit">Create week</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* =========================
   Work Hours Tracker - report.html script (v2)
   FIXES:
   ‚úÖ Week list shows correct pay (applies Sunday/BH premium)
   ‚úÖ No duplicate function names
   ‚úÖ Safe BH cache + limited API calls
   ‚úÖ Detail view still uses front-end "truth" calculation
========================= */

const $ = (id) => document.getElementById(id);
const show = (el) => el && el.classList.remove("hidden");
const hide = (el) => el && el.classList.add("hidden");

function fmtEUR(n){
  const v = Number(n || 0);
  try { return v.toLocaleString(undefined, { style:"currency", currency:"EUR" }); }
  catch { return "‚Ç¨" + v.toFixed(2); }
}

async function api(path, opts = {}){
  const res = await fetch(path, {
    credentials:"include",
    headers: { "Content-Type":"application/json", ...(opts.headers||{}) },
    ...opts
  });
  const ct = res.headers.get("content-type") || "";
  const data = ct.includes("application/json") ? await res.json() : await res.text();
  if(!res.ok){
    const msg = (data && data.detail) ? data.detail : (typeof data === "string" ? data : "Request failed");
    const e = new Error(msg);
    e.status = res.status;
    throw e;
  }
  return data;
}

/* =========================
   Helpers
========================= */
function getWeekId(){
  const p = new URLSearchParams(location.search);
  const w = p.get("week_id");
  return w ? Number(w) : null;
}
function goWeek(id){
  location.href = "/report?week_id=" + encodeURIComponent(id);
}
function back(){
  const id = getWeekId();
  if (id) location.href = "/report";
  else if (history.length > 1) history.back();
  else location.href = "/";
}
function minutesFromHHMM(hhmm){
  if(!hhmm || !String(hhmm).includes(":")) return 0;
  const [h,m] = String(hhmm).split(":").map(x=>parseInt(x,10));
  return (Number.isFinite(h)?h:0)*60 + (Number.isFinite(m)?m:0);
}
function ymdToDateObj(ymd){
  const [y,m,d] = String(ymd).split("-").map(Number);
  return new Date(y, (m||1)-1, d||1);
}

/* =========================
   Bank Holiday lookup (cache)
========================= */
const bhCache = new Map();
async function bhLookup(dateYmd){
  if (!dateYmd) return null;
  if (bhCache.has(dateYmd)) return bhCache.get(dateYmd);
  const r = await api(`/api/bank-holidays/lookup?date_ymd=${encodeURIComponent(dateYmd)}`);
  bhCache.set(dateYmd, r);
  return r;
}
function isBhTrue(bh){
  if (!bh) return false;
  return bh.is_bh === true || bh.is_bank_holiday === true || bh.isBH === true;
}

/* =========================
   Premium multiplier (Sunday/BH)
========================= */
async function premiumForDateYmd(ymd){
  let mult = 1;

  // Sunday
  const dt = ymdToDateObj(ymd);
  if (dt.getDay() === 0) mult = Math.max(mult, 1.5);

  // Bank Holiday
  try{
    const bh = await bhLookup(ymd);
    if (isBhTrue(bh)) mult = Math.max(mult, 1.5);
  }catch{}

  return mult;
}

/* =========================
   Profile (rate priority)
========================= */
let ME = null;
async function loadMe(){
  if (ME) return ME;
  try { ME = await api("/api/me"); }
  catch { ME = null; }
  return ME;
}

/* =========================
   Add week modal helpers
========================= */
function isoWeekNumber(d = new Date()) {
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
}
function mondayOfThisWeek(d = new Date()) {
  const x = new Date(d);
  const day = x.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  const y = x.getFullYear();
  const m = String(x.getMonth() + 1).padStart(2, "0");
  const dd = String(x.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}
function openAddWeekModal2(defaultRate = 0){
  $("addWeekErr2").textContent = "";
  $("aw2WeekNumber").value = String(isoWeekNumber(new Date()));
  $("aw2StartDate").value = mondayOfThisWeek(new Date());
  $("aw2HourlyRate").value = String(Number(defaultRate || 0).toFixed(2));
  show($("addWeekModal2"));
}
function closeAddWeekModal2(){
  hide($("addWeekModal2"));
  $("addWeekErr2").textContent = "";
}

/* =========================
   State
========================= */
let ACTIVE_WEEK_ID = null;
let ACTIVE_ENTRY_ID = null;
let ACTIVE_WEEK_RATE = 0;

/* =========================
   Edit modal
========================= */
function openEditModal({ title, entryId, date, timeIn, timeOut, breakMin, note }){
  $("modalErr").textContent = "";
  $("modalTitle").textContent = title || "Edit day";
  ACTIVE_ENTRY_ID = entryId || null;

  $("mDate").value = date ? date : "";
  $("mIn").value = timeIn || "";
  $("mOut").value = timeOut || "";
  $("mBreak").value = String(Number(breakMin || 0));
  $("mNote").value = note || "";

  $("btnDeleteDay").style.display = entryId ? "" : "none";
  show($("editModal"));
}
function closeEditModal(){
  hide($("editModal"));
  $("modalErr").textContent = "";
}

/* =========================
   Day details modal
========================= */
function openDayDetails(entryId) {
  const modal = $("dayModal");
  const ddTitle = $("ddTitle");
  const ddClocked = $("ddClocked");
  const ddTesco = $("ddTesco");
  const ddResult = $("ddResult");

  api(`/api/day-details/${entryId}`)
    .then(d => {
      ddTitle.textContent = `${d.weekday} ‚Ä¢ ${d.date}`;

      ddClocked.innerHTML = `
        <strong>IN:</strong> ${d.clocked.in || "‚Äî"}<br>
        <strong>OUT:</strong> ${d.clocked.out || "‚Äî"}<br>
        <strong>Break real:</strong> ${d.clocked.break_real ?? 0} min
      `;

      ddTesco.innerHTML = `
        <strong>Shift:</strong> ${d.tesco.shift || "‚Äî"}<br>
        <strong>Tolerance:</strong> ${d.tesco.tolerance || "‚Äî"}<br>
        <strong>Fixed break:</strong> ${d.tesco.break_fixed ?? 60} min
      `;

      ddResult.innerHTML = `
        <strong>Hours made:</strong> ${d.result.hours_made || "00:00"}<br>
        <strong>Hours paid:</strong> ${d.result.hours_paid || "00:00"}<br>
        <strong>Pay:</strong> ‚Ç¨${Number(d.result.pay ?? 0).toFixed(2)}
      `;

      show(modal);
    })
    .catch(err => alert(err.message || "Failed to load day details"));
}
function closeDayModal() {
  hide($("dayModal"));
}
(() => {
  const m = $("dayModal");
  if (!m) return;
  m.addEventListener("click", (e) => {
    if (e.target === m) closeDayModal();
  });
})();

/* =========================
   ‚úÖ Core fix: calculate week pay with premium
   Used for LIST view so it matches DETAIL view.
========================= */
async function calcWeekPayWithPremium(weekObj, fallbackRate = 0){
  const rate = Number(weekObj?.hourly_rate || 0) || Number(fallbackRate || 0);
  const entries = Array.isArray(weekObj?.entries) ? weekObj.entries : [];
  let total = 0;

  // prefetch BH for unique dates to reduce calls
  const uniqueDates = [...new Set(entries.map(e => e.work_date).filter(Boolean))];
  await Promise.all(uniqueDates.map(d => bhLookup(d).catch(()=>null)));

  for (const e of entries) {
    const mins = minutesFromHHMM(e.worked_hhmm || "00:00");
    if (!mins) continue;

    let mult = Number(e.multiplier || 1);

    if (e.work_date) {
      const prem = await premiumForDateYmd(e.work_date);
      mult = Math.max(mult, prem);
    }

    total += (mins / 60) * rate * mult;
  }

  return total;
}

/* =========================
   Views
========================= */
async function loadList(){
  hide($("viewDetail"));
  show($("viewList"));
  $("subTitle").textContent = "Select a week";
  $("weeksList").innerHTML = "";
  $("listErr").textContent = "";
  $("listMsg").textContent = "Loading...";

  try{
    const me = await loadMe();
    const weeks = await api("/api/weeks", { method:"GET" });

    if(!weeks || !weeks.length){
      $("listMsg").textContent = "No weeks yet. Create a week first.";
      return;
    }

    $("listMsg").textContent = "";

    // Render fast first, then correct pay (async update)
    for(const w of weeks){
      const item = document.createElement("div");
      item.className = "weekItem";

      item.innerHTML = `
        <div class="weekLeft">
          <div class="t1">Week ${w.week_number}</div>
          <div class="t2">Start: ${w.start_date}</div>
        </div>
        <div class="weekRight">
          <div class="hhmm">${w.total_hhmm || "00:00"}</div>
          <div class="eur" data-week-pay="1">${fmtEUR(w.total_pay || 0)}</div>
        </div>
      `;
      item.addEventListener("click", () => goWeek(w.id));
      $("weeksList").appendChild(item);

      // ‚úÖ FIX: fetch full week and recalc premium pay to match detail
      (async () => {
        try{
          const full = await api("/api/weeks/" + w.id, { method:"GET" });
          const rateFromProfile = Number(me?.hourly_rate || 0);
          const rateForCalc = rateFromProfile > 0 ? rateFromProfile : Number(full?.hourly_rate || 0);

          const pay = await calcWeekPayWithPremium(full, rateForCalc);
          const eurEl = item.querySelector('[data-week-pay="1"]');
          if (eurEl) eurEl.textContent = fmtEUR(pay);
        }catch{
          // keep original value
        }
      })();
    }
  }catch(e){
    $("listMsg").textContent = "";
    $("listErr").textContent = "Error loading weeks: " + (e.message || "failed");
    if(e.status === 401) location.href = "/";
  }
}

async function loadDetail(weekId){
  ACTIVE_WEEK_ID = weekId;

  hide($("viewList"));
  show($("viewDetail"));
  $("detailErr").textContent = "";
  $("rows").innerHTML = "";
  $("rateText").textContent = "‚Äî";
  $("startDateText").textContent = "‚Äî";
  $("totalHHMM").textContent = "00:00";
  $("totalPay").textContent = "‚Ç¨0.00";

  try{
    const me = await loadMe();
    const w = await api("/api/weeks/" + weekId, { method:"GET" });

    const rateFromProfile = Number(me?.hourly_rate || 0);
    const rateFromWeek = Number(w?.hourly_rate || 0);
    ACTIVE_WEEK_RATE = rateFromProfile > 0 ? rateFromProfile : rateFromWeek;

    $("subTitle").textContent = `Week ${w.week_number} ‚Ä¢ Weekly report`;
    $("rateText").textContent = `‚Ç¨${Number(ACTIVE_WEEK_RATE || 0).toFixed(2)} / hour`;
    $("startDateText").textContent = w.start_date || "‚Äî";

    const entries = Array.isArray(w.entries) ? w.entries : [];

    // prefetch BH for all unique dates
    const uniqueDates = [...new Set(entries.map(x => x.work_date).filter(Boolean))];
    await Promise.all(uniqueDates.map(d => bhLookup(d).catch(()=>null)));

    let totalMin = 0;
    let totalPay = 0;

    if(!entries.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">No days yet. Click ‚ÄúAdd day‚Äù.</td>`;
      $("rows").appendChild(tr);
    } else {
      for(const e of entries){
        const mins = minutesFromHHMM(e.worked_hhmm || "00:00");
        totalMin += mins;

        // multiplier: backend OR Sunday/BH premium (max)
        let mult = Number(e.multiplier || 1);
        if (e.work_date) {
          const prem = await premiumForDateYmd(e.work_date);
          mult = Math.max(mult, prem);
        }

        const rowPay = (mins/60) * Number(ACTIVE_WEEK_RATE || 0) * mult;
        totalPay += rowPay;

        const tr = document.createElement("tr");
        tr.className = "rowClick";
        tr.dataset.entryId = e.id;

        tr.innerHTML = `
          <td>${e.weekday || ""}</td>
          <td>${e.work_date || ""}</td>
          <td>${e.time_in || "‚Äî"}</td>
          <td>${e.time_out || "‚Äî"}</td>
          <td>${(e.break_minutes ?? 0)}m</td>
          <td>${e.worked_hhmm || "00:00"}</td>
          <td>${fmtEUR(rowPay)}</td>
          <td>
            <button class="btn btn--soft btnSmall" type="button" data-details="1">View</button>
          </td>
        `;

        const btn = tr.querySelector('button[data-details="1"]');
        if (btn) {
          btn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            openDayDetails(e.id);
          });
        }

        tr.addEventListener("click", () => {
          openEditModal({
            title: "Edit day",
            entryId: e.id,
            date: e.work_date,
            timeIn: e.time_in || "",
            timeOut: e.time_out || "",
            breakMin: e.break_minutes || 0,
            note: e.note || ""
          });
        });

        $("rows").appendChild(tr);
      }
    }

    // totals
    const paidHH = String(Math.floor(totalMin / 60)).padStart(2, "0");
    const paidMM = String(totalMin % 60).padStart(2, "0");
    $("totalHHMM").textContent = `${paidHH}:${paidMM}`;
    $("totalPay").textContent  = fmtEUR(totalPay);

    const madePaidEl = $("totalMadeVsPaid");
    if (madePaidEl) madePaidEl.textContent = `Paid: ${paidHH}:${paidMM} ‚Ä¢ (Details per day: View)`;

  }catch(e){
    $("detailErr").textContent = "Error loading report: " + (e.message || "failed");
    if(e.status === 401) location.href = "/";
  }
}

/* =========================
   Binds
========================= */
$("btnHome").addEventListener("click", () => location.href = "/");
$("btnBack").addEventListener("click", back);
$("btnPrint").addEventListener("click", () => window.print());

$("btnCloseModal").addEventListener("click", closeEditModal);
$("editModal").addEventListener("click", (e)=>{ if(e.target === $("editModal")) closeEditModal(); });

$("btnCloseAddWeek2").addEventListener("click", closeAddWeekModal2);
$("addWeekModal2").addEventListener("click", (e)=>{ if(e.target === $("addWeekModal2")) closeAddWeekModal2(); });

$("btnAddWeekHere").addEventListener("click", async () => {
  let defaultRate = 0;
  try{
    const me = await loadMe();
    defaultRate = Number(me?.hourly_rate || 0);
    if (!defaultRate) {
      const weeks = await api("/api/weeks", { method:"GET" });
      if (weeks && weeks.length) defaultRate = Number(weeks[0].hourly_rate || 0);
    }
  }catch{}
  openAddWeekModal2(defaultRate);
});

$("addWeekForm2").addEventListener("submit", async (ev) => {
  ev.preventDefault();
  $("addWeekErr2").textContent = "";

  try{
    const week_number = Number($("aw2WeekNumber").value || 0);
    const start_date  = ($("aw2StartDate").value || "").trim();
    const hourly_rate = Number($("aw2HourlyRate").value || 0);

    await api("/api/weeks", {
      method:"POST",
      body: JSON.stringify({ week_number, start_date, hourly_rate })
    });

    closeAddWeekModal2();
    await loadList();
  }catch(e){
    $("addWeekErr2").textContent = e.message || "Failed to create week";
    if(e.status === 401) location.href = "/";
  }
});

$("btnAddDay").addEventListener("click", () => {
  openEditModal({
    title: "Add day",
    entryId: null,
    date: "",
    timeIn: "",
    timeOut: "",
    breakMin: 0,
    note: ""
  });
});

$("btnDeleteWeek").addEventListener("click", async () => {
  if(!ACTIVE_WEEK_ID) return;
  const ok = confirm("Delete this week? This will remove all days inside it.");
  if(!ok) return;

  try{
    await api("/api/weeks/" + ACTIVE_WEEK_ID, { method:"DELETE" });
    location.href = "/report";
  }catch(e){
    $("detailErr").textContent = e.message || "Failed to delete week";
  }
});

$("editForm").addEventListener("submit", async (ev) => {
  ev.preventDefault();
  $("modalErr").textContent = "";

  if(!ACTIVE_WEEK_ID){
    $("modalErr").textContent = "Missing week.";
    return;
  }

  const work_date = ($("mDate").value || "").trim();
  const time_in = ($("mIn").value || "").trim() || null;
  const time_out = ($("mOut").value || "").trim() || null;
  const break_minutes = Number($("mBreak").value || 0);
  const note = ($("mNote").value || "").trim() || null;

  if(!work_date){
    $("modalErr").textContent = "Pick a date.";
    return;
  }

  try{
    await api("/api/weeks/" + ACTIVE_WEEK_ID + "/entry", {
      method: "PUT",
      body: JSON.stringify({
        work_date,
        time_in,
        time_out,
        break_minutes,
        note,
        bh_paid: null
      })
    });

    closeEditModal();
    await loadDetail(ACTIVE_WEEK_ID);
  }catch(e){
    $("modalErr").textContent = e.message || "Failed to save day";
    if(e.status === 401) location.href = "/";
  }
});

$("btnDeleteDay").addEventListener("click", async () => {
  if(!ACTIVE_ENTRY_ID){
    closeEditModal();
    return;
  }
  const ok = confirm("Delete this day entry?");
  if(!ok) return;

  try{
    await api("/api/entries/" + ACTIVE_ENTRY_ID, { method:"DELETE" });
    closeEditModal();
    await loadDetail(ACTIVE_WEEK_ID);
  }catch(e){
    $("modalErr").textContent = e.message || "Failed to delete day";
  }
});

/* =========================
   Init
========================= */
(async function init(){
  const id = getWeekId();
  if(id) await loadDetail(id);
  else await loadList();
})();
</script>

</body>
</html>
