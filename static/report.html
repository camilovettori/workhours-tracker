<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Week Report</title>
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body>
  <div class="app">
    <div class="pageHead between">
      <div>
        <div id="t" class="title">Week Report</div>
        <div id="m" class="subtitle"></div>
      </div>
      <button class="btn secondary" onclick="window.print()">Print</button>
    </div>

    <div class="card">
      <div id="p" class="pill">Total —</div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>In</th><th>Out</th><th>Break</th><th>Worked</th><th>1.5x</th><th>Note</th>
            </tr>
          </thead>
          <tbody id="b"></tbody>
        </table>
      </div>

      <div id="err" class="msg"></div>
    </div>
  </div>

  <script>
    async function api(path) {
      const res = await fetch(path, { credentials: "include" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || ("HTTP " + res.status));
      return data;
    }

    function showError(msg) {
      document.getElementById("err").textContent = String(msg || "");
    }

    (async () => {
      try {
        const params = new URLSearchParams(location.search);
        const week_id = params.get("week_id");
        if (!week_id) {
          showError("Missing week_id in URL.");
          return;
        }

        const w = await api(`/api/weeks/${encodeURIComponent(week_id)}`);

        document.getElementById("t").textContent = `Week ${w.week_number} Report`;
        document.getElementById("m").textContent = `Start: ${w.start_date} • Rate: €${Number(w.hourly_rate || 0).toFixed(2)}`;
        document.getElementById("p").textContent = `Total ${w.totals.total_hhmm} • €${Number(w.totals.total_pay || 0).toFixed(2)}`;

        const tb = document.getElementById("b");
        tb.innerHTML = "";

        if (!w.entries || !w.entries.length) {
          tb.innerHTML = `<tr><td colspan="8" class="muted">No days in this week.</td></tr>`;
          return;
        }

        for (const e of w.entries) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${e.weekday || ""}</b></td>
            <td>${e.date_ddmmyyyy || ""}</td>
            <td>${e.time_in || ""}</td>
            <td>${e.time_out || ""}</td>
            <td>${Number(e.break_minutes || 0)}m</td>
            <td><b>${e.worked_hhmm || ""}</b></td>
            <td>${Number(e.multiplier || 1) === 1.5 ? "YES" : ""}</td>
            <td>${e.note || ""}</td>
          `;
          tb.appendChild(tr);
        }
      } catch (err) {
        showError(err);
      }
    })();
  </script>
</body>
</html>
